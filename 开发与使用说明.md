# Team 7 积分小程序 · 开发与使用说明

## 项目概览
- 技术栈：原生微信小程序 + 云开发（云函数/云数据库/云存储）
- 云环境：`cloudbase-0gvjuqae479205e8`
- 主要模块：上传打卡、积分排行、积分商城、公告、我的、管理员后台、训练助手/铁人工具、数据分析、合作伙伴展示

## 页面结构
- 首页 `pages/home/home`
  - 公告轮播、快捷入口、合作伙伴展示（管理员点击图片上传/替换）
- 上传打卡 `pages/upload/upload`
  - 类别选择、积分计算、图片凭证上传、规则折叠说明（大铁1200、70.3为600）
- 排行榜 `pages/leaderboard/leaderboard`
  - 年度积分排名
- 积分商城 `pages/store/store`
  - 商品列表、详情兑换、下拉刷新（缓存5分钟）
- 我的 `pages/profile/profile`
  - 个人信息、积分总览、功能入口（管理员入口包括审核/公告/成员/商品/数据分析）
- 工具
  - 训练助手 `pages/training-assistant/training-assistant`
  - 铁人工具 `pages/tools/tools`
- 管理员后台
  - 审核 `pages/admin/audit/audit`
    - 列表缩略图展示、直接“通过/拒绝/取消通过/重新通过”；“已拒绝”可点进详情页查看拒绝理由 `pages/admin/audit/detail/detail`
  - 成员管理 `pages/admin/members/members`
    - 分页25、排序（积分/姓名）、搜索去抖、分片渲染、总人数｜正式会员小字统计
  - 商品管理 `pages/admin/products/products`
    - 上架/下架、编辑（支持尺码库存或总库存）、图片管理
  - 数据分析 `pages/admin/analytics/analytics`
    - 总访问、分类柱状图（主页/工具/上传/积分榜/兑换/后台）、业务概览（累计上传/审核/上架），支持7天/30天/总累计

## 云函数结构（关键）
- 统计与分析 `cloudfunctions/statisticsManager`
  - `recordVisit`：记录页面访问（按`category`+`page`+日聚合）
  - `getQuickAnalytics`：获取访问汇总与业务概览（支持 `7d/30d/all`）
  - `upsertPartner`：管理员写入合作伙伴图片 `partners/{key}`
  - `getPartners`：读取六个位置的 `fileID` 映射
  - 其余个人/管理员统计与趋势接口（见源码）
- 审核与积分记录
  - `submitPoints`：提交积分记录（待审核）
  - `auditPointRecord`：审核通过/拒绝（带理由）
  - `getPointRecords/getPointRecordDetail`：列表与详情读取
- 商城与兑换
  - `getProducts`：拉取上架且库存>0的商品
  - `adminManageProducts`：上架/下架、编辑；启用尺码时总库存=尺码之和；未启用尺码时保留手动总库存
  - `exchangeProduct`：积分兑换流程（校验用户资格/库存/尺码、写入流水）
  - `getExchangeHistory`：兑换记录
- 成员管理
  - `adminManageMembers`：设置/取消正式会员、管理员权限、积分增减等
- 公告/消息/统计等其他函数（见 `cloudfunctions/*`）

## 数据与集合
- `users`：用户资料、权限标记、年度缴费等
- `point_records`：积分打卡记录（含图片凭证、状态）
- `exchange_records`：兑换记录（状态、物流）
- `products`：商品信息、库存（总库存或尺码库存）
- `announcements`：公告
- `app_metrics`：访问统计（`day/category/page/count`）
- `partners`：合作伙伴图片 `fileID` 映射（键位：`descente/qrtri/quintanaroo/kse/extra1/extra2`）

## 权限与角色
- 普通用户：上传打卡、个人信息、排行、商城兑换、工具使用
- 管理员：审核、公告管理、成员与商品管理、数据分析、首页合作伙伴图片上传

## 关键实现与约定
- 上传打卡积分规则：
  - 大铁：1200分；70.3：600分；标铁：300；半程标铁：200；青少年短距离：200；半马：300；路跑（半程以上）：100；站台前三：+200
- 审核页缩略图稳定显示：
  - 列表读取 `imageFileIDs/imageUrl/formData.*`→批量 `getTempFileURL`→统一压缩参数 `?imageMogr2/thumbnail/600x/quality/75/format/webp`→`thumb` 字段展示
- 商城商品刷新与缓存：
  - 本地缓存5分钟；支持下拉刷新；管理员上架/下架后清缓存并强制刷新
- 合作伙伴图片：
  - 管理员点击图片上传，云端写入 `partners/{key}.fileID`；所有设备启动时通过云函数读取并批量转临时链接显示
  - 下载合法域名必须配置：`https://636c-cloudbase-0gvjuqae479205e8-1377814389.tcb.qcloud.la`
- 访问统计：
  - App与页面 `onShow` 调用 `recordVisit(category, route)`；分析页拉取 `getQuickAnalytics(timeRange)`

## 开发与部署
- 云函数部署：在微信开发者工具 → 云开发 → 云函数 → 选择函数 → “上传并部署（云端安装依赖）”
  - 必须部署：`statisticsManager`、`adminManageProducts`（如云端版本较旧）
- 环境一致性：
  - `cloudbaserc.json` 与 `app.js` 的云环境需一致：`cloudbase-0gvjuqae479205e8`
- 域名配置（手机端）：
  - 小程序后台 → 开发设置 → 服务器域名 → 下载文件合法域名：`https://636c-cloudbase-0gvjuqae479205e8-1377814389.tcb.qcloud.la`

## 使用指引（用户）
- 上传打卡：选择类别→填写说明→上传图片→提交，等待审核；规则折叠可查看分值
- 排行榜：查看年度积分排名
- 积分兑换：浏览商品→进入详情→选择尺码/收件信息→提交订单→查看物流
- 我的：查看积分与入口；完善头像昵称与收件信息
- 工具：训练助手（阈值/分区/预测）、铁人工具（胎压建议）

## 使用指引（管理员）
- 审核：列表直接“通过/拒绝”，已拒绝可点详情查看理由
- 成员：查看与排序、搜索、调整正式会员/管理员、变更积分
- 商品：编辑信息与库存；启用尺码时总库存=尺码库存之和；未启用尺码保留手动总库存
- 数据分析：查看总访问与分类柱状图（7天/30天/总累计）、业务概览
- 合作伙伴：在首页图片位置点击上传或替换；跨设备统一显示

## 常见问题
- 图片不显示：检查“下载文件合法域名”是否已配置为 `*.tcb.qcloud.la` 的实际环境域名
- 重新上架未显示：确保库存>0、状态上架；在商城页下拉刷新；管理员变更后会自动清缓存
- 审核列表图片转圈：已修复为批量临时链接+压缩缩略图；如个别记录仍异常，检查该记录的 `fileID` 是否有效

## 变更摘要（近期）
- 新增“数据分析”页面与访问统计链路
- 合作伙伴图片改为云集合统一管理，管理员点击图片上传
- 审核列表缩略图稳定化与拒绝理由弱提示
- 成员管理分页25、排序/搜索去抖/分片渲染与布局优化
- 积分规则更新：大铁1200、70.3为600；文案与计算一致