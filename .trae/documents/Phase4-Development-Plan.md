# Phase 4 Development Plan

## 项目概述

本阶段开发计划针对三个核心需求：修复付费版云存储权限后的图片加载问题、支持会员负积分设置、以及实现基于比赛参与情况的会员兑换锁定机制。这些功能将提升系统的权限管理能力和用户体验。

## 1. 云存储权限修复

### 1.1 问题描述
- 已升级到付费版云开发，获得完整权限
- 需要修复之前因权限限制导致的图片加载失败问题
- 优化图片处理逻辑，支持新的权限配置

### 1.2 核心功能
- **权限状态检测**：自动检测云存储权限状态
- **图片URL转换优化**：修复付费版后的临时URL生成
- **错误处理增强**：提供更准确的权限错误诊断
- **缓存机制优化**：更新缓存策略以适应新权限

### 1.3 技术实现
- 更新 `imageUtils.js` 中的权限检测逻辑
- 修复 `convertCloudUrlWithRetry` 方法中的权限处理
- 优化临时URL缓存和过期策略
- 添加付费版权限验证

## 2. 负积分支持

### 2.1 问题描述
- 手动设置会员积分时需要支持负数值
- 某些会员可能因违规或其他原因需要扣除积分至负值
- 需要确保系统各部分都能正确处理负积分

### 2.2 核心功能
- **负积分输入支持**：管理员界面支持输入负数值
- **负积分显示**：在前端正确显示负积分
- **积分计算逻辑**：确保积分运算支持负数
- **负积分限制**：设置合理的负积分下限

### 2.3 涉及页面
- **管理员积分设置页面**：支持负数值输入和验证
- **会员个人资料页面**：正确显示负积分
- **积分记录页面**：显示负积分变动历史
- **排行榜页面**：处理负积分排序

### 2.4 技术实现
- 更新数据库schema支持负数值
- 修改前端输入验证逻辑
- 更新积分计算和显示组件
- 添加负积分业务规则验证

## 3. 会员兑换锁定机制

### 3.1 问题描述
- 部分会员可能参加活动但未参加比赛，需要限制其兑换权限
- 需要实现手动锁定和基于比赛参与的自动解锁机制
- 锁定状态需要在会员参加比赛后自动解除

### 3.2 核心功能
- **手动锁定管理**：管理员可以手动锁定/解锁会员兑换权限
- **自动解锁机制**：参加比赛后自动解锁兑换权限
- **锁定状态显示**：在会员界面显示锁定状态和原因
- **兑换权限验证**：在兑换流程中验证锁定状态

### 3.3 业务流程
1. **锁定流程**：
   - 管理员识别需要锁定的会员
   - 设置锁定原因（未参加比赛等）
   - 会员端显示锁定状态和说明

2. **解锁流程**：
   - 会员参加比赛并提交成绩
   - 系统自动检测比赛参与情况
   - 满足条件后自动解锁兑换权限
   - 发送解锁通知给会员

### 3.4 技术实现
- **数据库扩展**：添加锁定状态字段和锁定原因
- **权限验证中间件**：在兑换流程中添加锁定状态检查
- **比赛参与检测**：自动检测会员比赛参与记录
- **定时任务**：定期检查并执行自动解锁

## 4. 数据库设计

### 4.1 用户表扩展
```sql
-- 用户表新增字段
ALTER TABLE users ADD COLUMN 
  exchange_locked BOOLEAN DEFAULT FALSE,
  lock_reason VARCHAR(255),
  locked_at TIMESTAMP,
  locked_by_admin_id UUID,
  auto_unlock_date TIMESTAMP,
  competition_participation_count INTEGER DEFAULT 0,
  last_competition_date TIMESTAMP;
```

### 4.2 锁定记录表
```sql
-- 创建锁定记录表
CREATE TABLE exchange_lock_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  action VARCHAR(20) NOT NULL, -- 'lock', 'unlock'
  reason VARCHAR(255),
  performed_by_admin_id UUID,
  created_at TIMESTAMP DEFAULT NOW()
);
```

## 5. 前端界面设计

### 5.1 管理员界面
- **会员管理页面**：添加锁定状态显示和操作按钮
- **积分设置页面**：支持负数值输入，添加输入验证
- **锁定记录页面**：显示锁定历史记录

### 5.2 会员界面
- **个人中心**：显示兑换锁定状态和原因
- **兑换页面**：锁定状态下显示提示信息
- **比赛参与提醒**：提示参加比赛以解锁兑换

## 6. API接口设计

### 6.1 负积分相关接口
```
PUT /api/admin/users/{userId}/points
{
  "points": -100,
  "reason": "违规扣分",
  "operation_type": "manual_set"
}
```

### 6.2 锁定相关接口
```
POST /api/admin/users/{userId}/exchange-lock
{
  "action": "lock",
  "reason": "未参加比赛",
  "auto_unlock_after_competition": true
}

POST /api/admin/users/{userId}/exchange-unlock
{
  "action": "unlock",
  "reason": "手动解锁"
}
```

### 6.3 比赛参与检测接口
```
POST /api/competitions/{competitionId}/participants
{
  "user_id": "user_uuid",
  "participation_status": "completed"
}
```

## 7. 业务规则

### 7.1 负积分规则
- 积分下限：-1000分（可配置）
- 负积分会员仍可正常参与大部分活动
- 负积分影响部分特权功能的使用

### 7.2 锁定规则
- 锁定原因必须明确记录
- 自动解锁基于比赛参与情况
- 手动解锁需要管理员权限
- 锁定状态变更需要记录日志

### 7.3 解锁条件
- 参加并完成指定数量的比赛（默认1场）
- 管理员手动解锁
- 达到设定的自动解锁日期

## 8. 技术架构

### 8.1 后端架构
- **权限验证层**：添加兑换权限验证中间件
- **业务逻辑层**：处理负积分计算和锁定逻辑
- **数据访问层**：更新数据库操作以支持新字段

### 8.2 前端架构
- **状态管理**：添加锁定状态和负积分显示状态
- **组件更新**：更新积分显示和输入组件
- **权限控制**：在前端添加兑换权限判断

## 9. 测试计划

### 9.1 功能测试
- 负积分设置和显示测试
- 锁定/解锁功能测试
- 比赛参与自动解锁测试
- 权限验证测试

### 9.2 性能测试
- 大量会员锁定状态查询性能
- 负积分计算性能影响
- 并发兑换请求处理

### 9.3 安全测试
- 权限绕过测试
- 负积分边界值测试
- 锁定状态篡改测试

## 10. 部署计划

### 10.1 第一阶段：云存储修复
- 修复付费版权限后的图片加载
- 更新图片处理逻辑
- 测试所有图片显示功能

### 10.2 第二阶段：负积分支持
- 数据库schema更新
- 管理员界面更新
- 负积分显示逻辑更新

### 10.3 第三阶段：锁定机制
- 数据库表结构创建
- 锁定逻辑实现
- 自动解锁机制部署

## 11. 风险评估

### 11.1 技术风险
- 数据库迁移可能影响现有数据
- 负积分计算可能影响现有业务逻辑
- 锁定机制可能影响用户体验

### 11.2 缓解措施
- 数据库迁移前完整备份
- 分阶段部署，逐步验证
- 提供回滚机制和应急预案

## 12. 预期效果

### 12.1 功能提升
- 图片加载成功率达到99%以上
- 支持完整的负积分业务流程
- 实现灵活的会员权限管理

### 12.2 用户体验
- 管理员操作更加便捷
- 会员权益管理更加精准
- 系统响应更加稳定可靠

这个开发计划涵盖了三个核心需求的完整实现方案，从需求分析到技术实现，再到测试部署，确保项目的顺利实施。