## 目标与范围
- 打卡积分调整：将“青少年短距离”积分从 80 改为 200，并同步规则文案与计算预览/提交。
- 新增“阈值工具”模块，含 3 个子页面：游泳、骑行、跑步；样式与现有“胎压助手”一致（同一 UI 结构与交互）。
- 阈值工具核心功能：
  - 游泳：基于 CSS（200m/400m测试）推算阈值速度与训练分区。
  - 骑行：基于 FTP 推算 LT1、LT2，并展示功率区间。
  - 跑步：基于 10K/半马/马拉松最佳成绩推算阈值配速与分区。

## 参考与算法依据
- 游泳 CSS：CSS = (距离₂ − 距离₁) / (时间₂ − 时间₁)，通常取 400m 与 200m；CSS 表征 1500m 可维持的速度。参考：MyProCoach（https://www.myprocoach.net/calculators/critical-swim-speed/）、Sport‑Calculator（https://sport-calculator.com/calculators/swimming/css-calculator）与 Effortless Swimming（https://effortlessswimming.com/css-calculator/）。
- 骑行 FTP 与阈值：FTP≈LT2 的近似值，训练分区可由 FTP 百分比给出（Coggan 等常见区间）。LT1 约位于 FTP 的 65–75% 区间，存在个体差异。参考：High North Performance（https://www.highnorth.co.uk/articles/cycling-training-zones, https://www.highnorth.co.uk/articles/polarised-training-cycling）。
- 跑步阈值（T pace）：约为“稳定跑 1 小时的速度”。可从比赛成绩估算（经验法则与 VDOT 概念）。经验：
  - 基于 10K：T 约为 10K 配速的 1.03 倍（慢 3%）。
  - 基于半马：T 约为半马配速的 0.96 倍（快 4%）。
  - 基于马拉松：T 约为马拉松配速的 0.92 倍（快 8%）。
  参考：McMillan 跑步法则与在线配速计算器（示例：https://www.mcmillanrunning.com/half-marathon-pace/、VDOT 说明 https://vdoto2.com/calculator）。

## 实施细节
### 1) 打卡积分改动
- 更新分值与文案：
  - 文件：`pages/upload/upload.js`
    - 将 `raceTypes` 中 `youth_sprint` 的 `points` 改为 200（当前行位置约 31–39）。
    - 更新站台加分保持 +200（预览与提交复算函数）。
  - 文件：`pages/upload/upload.wxml` 与 `pages/upload/upload.js` 弹窗文案
    - 同步将“青少年短距离：200分”与相关比赛分值展示更新。
- 验证：切换到“参加比赛”类别，选择“青少年短距离”后预显示为 +200；提交数据中的 `points` 与 `formData` 一致。

### 2) 阈值工具信息架构
- 入口：扩展 `pages/tools/tools.wxml` 的分页 Tab，新增一个“阈值工具”分页，内部再用二级 Tab（游泳/骑行/跑步）。
- 子页面结构（每个页面四区块，复用胎压助手的样式类）：
  - 页面标题（主标题+副标题）
  - 输入区域（`input-group` / `picker` / `input`）
  - 操作按钮（计算/重置，含 `calculating` 状态）
  - 结果展示（`result-section`，卡片式区间列表）
- 代码位置：
  - 新增目录 `pages/tools/threshold/swim|bike|run`（各含 `.js/.wxml/.wxss/.json`）。
  - 共享工具方法可置于 `utils/thresholdUtils.js`（时间/速度/配速转换、区间计算、格式化）。

### 3) 游泳子页（CSS）
- 输入：`200m` 与 `400m` 成绩（`mm:ss`）。
- 计算：
  - 将两次成绩转换为秒：`t200、t400`；CSS 速度 `v_css = (400 - 200) / (t400 - t200)`（m/s）。
  - 阈值配速（每 100m）`pace100 = 100 / v_css`（秒），格式化为 `mm:ss/100m`。
- 分区展示（基于 CSS）：
  - 热身/恢复：`pace100 + 15–25s`
  - z1 恢复：`pace100 + 10–15s`
  - z2 有氧：`pace100 + 5–10s`
  - z3 节奏：`pace100 ± 0–5s`
  - z4 阈值门槛：`pace100 − 5–10s`
  - z5 乳酸耐受/VO2：`pace100 − 10–20s`
- 边界处理：校验 `t400 > t200` 且二者为最大努力；异常时提示重新测试。

### 4) 骑行子页（FTP→LT1/LT2 与功率区）
- 输入：`FTP`（整数 w），可提供“20 分钟最大功率×95%”辅助输入。
- 计算：
  - LT1 = `round(0.75 × FTP)`（默认；提供设置项允许用户微调范围 0.65–0.80）。
  - LT2 = `round(1.00 × FTP)`（即 FTP）。
- 分区（默认“Tri 区间”，贴近示例图）：
  - 热身/冷身：`0–0.40×FTP`
  - z1 恢复：`0.40–0.71×FTP`
  - z2 有氧：`0.71–0.83×FTP`（LT1≈下边界上方）
  - z3 节奏：`0.83–0.91×FTP`
  - z4 阈值门槛：`0.91–1.00×FTP`（LT2≈上边界）
  - z5A 阈值上限：`1.00–1.02×FTP`
  - z5B 最大摄氧量：`1.02–1.10×FTP`
  - z5C 无氧能力：`≥1.10×FTP`
- 选项：允许切换为“Coggan 经典区间”（`<55%`、`56–75%`、`76–90%`、`91–105%`、`106–120%`、`>121%`）。

### 5) 跑步子页（比赛成绩→T 配速与区间）
- 输入：选择其一并提供成绩：`10K` / `半马` / `马拉松`（支持 `hh:mm:ss`）。
- 计算：
  - 转换为配速（秒/公里）。
  - 阈值配速 `T`：
    - 来自 10K：`T = 1.03 × 10K 配速`
    - 来自 半马：`T = 0.96 × 半马配速`
    - 来自 马拉松：`T = 0.92 × 马拉松配速`
- 分区（基于阈值速度 `vT`）：
  - 热身/恢复：`速度 70–80% vT`（对应配速更慢，显示为较大 `min/km` 值）
  - z1 恢复：`80–88% vT`
  - z2 有氧：`88–94% vT`
  - z3 马拉松：`94–98% vT`
  - z4 阈值门槛：`98–102% vT`（LT2≈T）
  - z5 速度间歇：`>102% vT`
- 结果展示：主卡片显示 `阈值配速（min/km）`，并标注 `LT1（~90% vT）`、`LT2（=T）`。

### 6) UI/UX 统一
- 复用胎压助手的四区块布局与按钮状态类名：`input-group`、`action-section`、`result-section` 等（参考 `pages/tools/tools.wxml`）。
- 结果卡片上下分隔线 + 标注 LT1/LT2；单位统一（游泳：`/100m`，骑行：`w`，跑步：`min/km`）。
- 表单校验与错误提示统一使用 `wx.showToast`。

### 7) 代码组织与测试
- 新增 `utils/thresholdUtils.js`：
  - 时间字符串↔秒转换；速度↔配速转换；四舍五入与单位格式化；区间生成。
- 单元测试：在项目根新增 `test_threshold_calculation.js`，覆盖：
  - CSS 公式与异常边界；FTP→功率区间计算；比赛成绩→阈值配速转换。
- 兼容性：不引入外部库，仅使用现有小程序 API 与工具。

### 8) 文案与多语言
- 更新 `i18n/base.json`：新增“阈值工具”与各区间名称、输入提示、单位标注；更新“青少年短距离 200分”的文本。
- 页面中文文案保持一致，后续可扩展英文。

## 交付里程碑
- M1：算法确定与工具方法实现（thresholdUtils.js）
- M2：三子页面 UI 与交互完成，初版可算出结果
- M3：与工具主页集成（Tab 切换），联调与样式统一
- M4：文案与 i18n 更新，单测通过，完成验收

## 验收与验证
- 对照截图，验证骑行页面显示 FTP、LT1/ LT2 与各区间边界值；跑步显示阈值配速与区间；游泳显示 CSS 配速与区间。
- 使用多组样例（含边界与异常）确保公式稳定；前端交互与提示统一。

## 需你确认
- 骑行区间与 LT1 默认比例（建议 LT1=0.75×FTP、LT2=1.00×FTP，显示可微调）。
- 跑步阈值估算的经验系数是否采纳上述默认值（10K +3%、半马 −4%、马拉松 −8%），或提供你更偏好的系数。
- 页面最新改动（2025-11-12）
  - 训练助手：
    - 跑步/游泳成绩输入改为分段填空（默认未填为 0）；分区卡片上方新增大字阈值展示；40km 预测卡片采用 IF=0.92 与 75kg 参数，均速行下追加平均功率，设定说明支持折叠（`pages/training-assistant/*`）。
  - 商城与兑换：
    - 服装商品支持尺码开关与各尺码库存录入，后端聚合总库存并展示为库存；兑换按所选尺码扣减库存；取消申请按尺码回滚库存并显示“已取消”状态；兑换历史中“已取消”显示扣减积分为 0（`pages/admin/products/*`、`cloudfunctions/adminManageProducts/*`、`cloudfunctions/getProducts/*`、`pages/store-detail/*`、`cloudfunctions/exchangeProduct/*`、`pages/admin/exchange/*`、`pages/exchange-history/*`）。