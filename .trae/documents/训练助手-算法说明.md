# 训练助手算法说明（跑步/骑行阈值与分区）

## 跑步：基于 Jack Daniels 与 VDOT 的计算

* 核心思路

  * 使用 Jack Daniels 的 VDOT 性能模型，将最近一次比赛成绩转换为“VDOT”（近似 VO2max 的可训练值），再由 VDOT 推导训练配速，尤其是阈值配速（T pace）。

* 性能→VDOT 计算（Daniels/Gilbert 公式）

  * 设比赛距离 `D`（米），比赛用时 `t`（分钟），比赛速度 `v = D / t`（米/分钟）

  * 计算氧耗：`VO2 = -4.6 + 0.182258 * v + 0.000104 * v^2`

  * 计算相对于 VO2max 的百分比：`%VO2max = 0.8 + 0.1894393 * e^(-0.012778 * t) + 0.2989558 * e^(-0.1932605 * t)`

  * 得到 `VDOT = VO2 / %VO2max`

  * 说明：上述公式用于由某一场比赛（如 5K/10K/半马/马拉松）反求当前 VDOT（参考文献 \[1]\[3]）

* 阈值配速（T pace）

  * Daniels 定义的 T 配速对应接近乳酸阈值的“舒适但吃力”的稳态配速，常用于 20–40 分钟的稳态或间歇训练（参考文献 \[3]）

  * 精确做法：通过 Daniels 训练表将 VDOT 映射到 T 配速

  * 工程近似（当前实现采用，便于无表格环境）

    * 基于经验近似 T 配速与比赛配速的关系：

      * 来自 10K：`T ≈ 10K 配速 × 1.03`（慢约 3%）

      * 来自 半马：`T ≈ 半马配速 × 0.96`（快约 4%）

      * 来自 马拉松：`T ≈ 马拉松配速 × 0.92`（快约 8%）

    * 说明：该近似以“阈值≈一小时比赛配速”的经验为基础，便于在小程序端快速计算，无需查表；如需更严格对齐 Daniels 表，可在后续版本引入 VDOT→T pace 的查表实现

* 跑步分区（基于阈值速度 vT）

  * 当前分区以 vT 为锚点，并与页面展示相匹配：

    * 热身/恢复：`70–80% vT`

    * z1 恢复：`80–88% vT`

    * z2 有氧：`88–94% vT`（LT1 取 z2 上沿 → `≈ 94% vT`）

    * z3 马拉松：`94–98% vT`

    * z4 阈值门槛：`98–100% vT`（LT2 取 z4 上沿 → `= 100% vT`，即 T 配速）

    * z5 速度间歇：`≥ 100% vT`

  * 页面逻辑：仅在 z2/z3 与 z4/z5 之间插入蓝色虚线显示 `LT1/LT2`，其他位置不重复展示

* 预测比赛成绩（严格 VDOT 等效）

  * 目标：给定当前 `VDOT` 与目标距离 `D`，求使 `VDOT(D, t) == VDOT` 的比赛时间 `t`

  * 方程：`VDOT(D, t) = VO2(D/t) / percent(t)`；其中 `VO2(v) = -4.6 + 0.182258 v + 0.000104 v^2`（`v` 为 m/min），`percent(t) = 0.8 + 0.1894393 e^{-0.012778 t} + 0.2989558 e^{-0.1932605 t}`（`t` 为分钟）

  * 数值解：使用二分法在 `[low, high]` 上迭代 40 次；初值由当前阈值速度估计后自适应扩展，使得 `VDOT(low) ≥ VDOT ≥ VDOT(high)`

  * 展示项：5K、10K、半马、全马，显示 `hh:mm:ss` 完赛时间与对应 `min/km` 配速

  * 实现位置：`pages/training-assistant/training-assistant.js:134–162`

## 骑行：基于 Andrew Coggan 的功率分区

* 核心思路

  * 以 FTP（功能性阈值功率，近似 60 分钟可维持的最大稳态功率）为锚点，根据 Coggan 的分区百分比设置训练区间（参考文献 \[1]\[2]\[4]）

* 区间边界（百分比以 FTP 为基准）

  * L1 Active Recovery：`< 55%`

  * L2 Endurance：`56–75%`

  * L3 Tempo：`76–90%`

  * L4 Threshold：`91–105%`

  * L5 VO2max：`106–120%`

  * L6 Anaerobic Capacity：`> 121%`

  * L7 Neuromuscular Power：短促最大冲刺（无固定百分比）

* 页面分区（贴合演示样式）

  * 热身/冷身：`0–40%`

  * z1 恢复：`40–71%`

  * z2 有氧：`71–83%`（LT1 取 z2 上沿 → `= 83% FTP`）

  * z3 节奏：`83–91%`

  * z4 阈值门槛：`91–100%`（LT2 取 z4 上沿 → `= 100% FTP`）

  * z5A 阈值上限：`100–102%`

  * z5B 最大摄氧量：`102–110%`

  * z5C 无氧能力：`≥ 110%`

  * 说明：上述边界在 UI 上做了轻度分段，以更贴近参考截图；若需严格对齐 Coggan 原始分区，可切换到标准边界显示

* LT1/LT2 的页面逻辑

  * 取 z2 上沿（LT1）与 z4 上沿（LT2），仅用蓝色虚线插入在 z2/z3 与 z4/z5A 之间显示数值

  * 其他位置不重复展示，避免信息拥挤

## 实装与验证

* 计算入口

  * 跑步：在“训练助手/跑步”页，输入来源（10K/半马/马拉松）与成绩，计算 T 配速与分区，并给出预测成绩卡片

  * 骑行：在“训练助手/骑行”页，输入 FTP（并提示“20 分钟测试×95%推算”），计算区间与 LT 虚线

* 视觉规范

* 阈值大字显示：分区卡片上方以蓝色大字展示“阈值配速/FTP”主值（`training-assistant.wxml:178–191, 205–214`）

* LT 虚线：使用项目主蓝色 `#1a237e` 的虚线与标签，插入在指定分区之间（`training-assistant.wxss:38–39`；`training-assistant.wxml:193–205, 216–228`）

* 游泳预测：CSS 下方新增 750m/1500m/1900m/3800m 预测，并显示 `/100m` 配速（`training-assistant.js:54–60`；`training-assistant.wxml:146–154`）

## 参考文献（检索来源）

* \[1] TrainingPeaks：Cycling Power Zones Explained，Dr. Andrew Coggan（<https://www.trainingpeaks.com/blog/power-training-levels/）>

* \[2] Hunter Allen：Power Training Zones 101（<https://www.hunterallenpowerblog.com/2015/05/power-training-zones-101.html）>

* \[3] CoachesEducation：Determining your current level of fitness（VDOT 概念与训练配速表）（<https://www.coacheseducation.com/endur/jack-daniels-nov-00.php）>

* \[4] Bicycling：Cycling Training Zones（Coggan 分区与 FTP 实践）（<https://www.bicycling.com/training/a43459881/cycling-power-zones/）>

* \[5] Daniels/Gilbert 公式讨论与引用（VO2 与 %VO2max 方程）：LetsRun 论坛摘录（<https://www.letsrun.com/forum/flat_read.php?thread=3704747）>

## 备注

* 跑步 T 配速已改为 VDOT→T pace 的严格数值解路径；如需完全按 Daniels 表对齐，可在下一版本引入 VDOT→各训练配速的查表数据以替换当前 0.88 近似强度。

* 预测比赛成绩现采用严格 VDOT 等效算法；Riegel 模型不再使用。

## 更新记录（2025-11-12）

* 跑步：统一秒/公里单位；分区范围按 `TsecPerKm / pct` 生成；LT1/蓝虚线插入位置修正（`training-assistant.js:108–121`，`training-assistant.wxml:216–228`）

* 跑步：预测成绩切换为严格 VDOT 等效数值解，并增加配速列（`training-assistant.js:134–162`；`training-assistant.wxml:243–251`）

* 骑行：分区卡片顶部新增 FTP 大字显示（`training-assistant.wxml:186–191`）

* 游泳：CSS 下方新增四距离预测，并显示 `/100m` 配速（`training-assistant.js:54–60`；`training-assistant.wxml:146–154`）

### 最新页面改动补充（2025-11-12）
- 输入分段填空与默认值：跑步（时/分/秒，缺省为 0）与游泳（分/秒，缺省为 0）已上线（`training-assistant.wxml:22–35, 105–114`；`training-assistant.js:43–63, 98–110`）。
- 40km 预测卡片优化：改用 IF=0.92，质量 75kg；均速行下新增“平均功率”，用时行仅显示配置说明；折叠“设定说明”按钮移至卡片底部（`training-assistant.js:71`；`training-assistant.wxml:106–117, 118–124`；`training-assistant.wxss:56–61`）。
