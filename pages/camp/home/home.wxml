<!--pages/camp/home/home.wxml-->
<view class="camp-home">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view wx:elif="{{error}}" class="error-container">
    <text class="error-text">{{error}}</text>
    <button wx:if="{{error === 'ä»…æ­£å¼ä¼šå‘˜å¯è®¿é—®è®­ç»ƒè¥åŠŸèƒ½'}}" class="upgrade-btn" bindtap="contactCoach">
      å‡çº§ä¼šå‘˜
    </button>
    <button wx:elif="{{error === 'è¯·å…ˆç™»å½•'}}" class="retry-btn" bindtap="reloadOrLogin">é‡æ–°åŠ è½½</button>
    <button wx:else class="retry-btn" bindtap="loadCampData">é‡æ–°åŠ è½½</button>
  </view>

  <!-- æ— æƒé™çŠ¶æ€ -->
  <view wx:elif="{{!hasAccess}}" class="access-denied">
    <image class="lock-icon" src="/images/lock.png" mode="aspectFit"></image>
    <text class="denied-title">è®­ç»ƒè¥åŠŸèƒ½ä»…é™æ­£å¼ä¼šå‘˜</text>
    <text class="denied-desc">æˆä¸ºæ­£å¼ä¼šå‘˜ï¼Œè§£é”è®­ç»ƒè®¡åˆ’</text>
    <button class="contact-btn" bindtap="contactCoach">è”ç³»æ•™ç»ƒ</button>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else class="main-content">
    <!-- å¤´éƒ¨åŒºåŸŸ -->
    <view class="header-section">
      <image class="hero-image" src="{{heroUrl}}" mode="aspectFill"></image>
      <view class="header-overlay">
        <view class="title-row">
          <text class="camp-title">{{campData.name}}</text>
          <view class="countdown-bubble">{{formatCountdown(daysToTargetRace)}}</view>
        </view>
        <text class="camp-desc">{{campSubtitle}}</text>
        <button class="course-btn" bindtap="navigateToCourse">èµ›é“è¯¦æƒ…ä¸å‚èµ›æŒ‡å¯¼</button>
      </view>
    </view>

    

    

    

    <!-- è®­ç»ƒè®¡åˆ’ -->
    <view class="training-plan-section" style="height: 1902rpx; display: block; box-sizing: border-box">
      <view class="section-header">
        <text class="section-title">13å‘¨è®­ç»ƒè®¡åˆ’</text>
        <view class="header-controls">
          <view class="nav-arrows">
            <button class="arrow-btn" bindtap="prevWeek">â—€</button>
            <text class="week-index">ç¬¬{{currentWeek}}å‘¨</text>
            <button class="arrow-btn" bindtap="nextWeek">â–¶</button>
          </view>
          <button class="leaderboard-btn" bindtap="viewLeaderboard">
            <text>è®­ç»ƒè¥æ’è¡Œæ¦œ</text>

          </button>
        </view>
      </view>

      <view class="top-row" style="height: 199rpx; display: flex; box-sizing: border-box">
        <view class="progress-overview" style="position: relative; left: -39rpx; top: 0rpx; width: 439rpx; display: block; box-sizing: border-box; height: 195rpx">
          <view class="progress-card" style="width: 414rpx; display: flex; box-sizing: border-box; position: relative; left: -39rpx; top: 0rpx">
            <view class="progress-item">
              <text class="progress-label">å®Œæˆè¿›åº¦</text>
              <text class="progress-value">{{userProgress.total_weeks_completed}}/{{userProgress.total_weeks}}</text>
            </view>
            <view class="progress-item">
              <text class="progress-label">æ•´ä½“å®Œæˆç‡</text>
              <text class="progress-value">{{userProgress.overall_completion}}%</text>
            </view>
            <view class="progress-item">
              <text class="progress-label">å¹³å‡å®Œæˆç‡</text>
              <text class="progress-value">{{userProgress.avg_completion_rate}}%</text>
            </view>
          </view>
        </view>
        <view class="countdown-card" style="position: relative; left: -72rpx; top: 0rpx; width: 249rpx; display: block; box-sizing: border-box">
          <text class="countdown-label">è·ç¦»æ¯”èµ›</text>
          <view class="flip-container">
            <block wx:for="{{countdownDigits}}" wx:for-item="digit" wx:for-index="idx" wx:key="idx">
              <view class="flip-digit">{{digit}}</view>
            </block>
            <text class="flip-suffix">å¤©</text>
          </view>
        </view>
      </view>

      <view class="weeks-container">

        <view class="week-card {{currentWeek === userProgress.current_week ? 'current-week' : ''}} {{userProgress.week_completion[currentWeek] ? 'completed-week' : ''}}">
          <view class="week-header" bindtap="toggleWeek" data-week="{{currentWeek}}">
            <view class="week-info">
              <text class="week-number">ç¬¬{{currentWeek}}å‘¨</text>
              <text class="week-phase" style="color: {{getPhaseColor(currentWeekData.phase)}}">{{currentWeekData.phase}}</text>
            </view>
            <view class="week-status">
              <text class="planned-time">{{weeklyMinutes}}åˆ†é’Ÿ â‰ˆ {{weeklyHours}}å°æ—¶</text>
              <text class="expand-icon">{{expandedWeeks[currentWeek] ? 'â–¼' : 'â–¶'}}</text>
            </view>
            
          </view>

          <view wx:if="{{expandedWeeks[currentWeek] && !isLocked}}" class="week-details">
            <view class="week-focus">
              <text class="focus-label">è®­ç»ƒé‡ç‚¹ï¼š</text>
              <text class="focus-text">{{currentWeekData.theme}}</text>
            </view>
            
              <view class="week-schedule">
              <text class="schedule-title">æ¯æ—¥å®‰æ’ï¼š</text>
              <view class="schedule-list">
                <block wx:for="{{displaySchedule}}" wx:for-item="day" wx:key="day">
                  <view class="day-item">
                    <text class="day-icon">{{day.typeIcon}}</text>
                    <view class="day-content">
                      <text class="day-activity">{{day.dayName}} Â· {{day.typeLabel}}{{day.titleSafe}}ï¼ˆ{{day.duration}}åˆ†é’Ÿï¼‰</text>
                      <text class="day-guidance">{{day.guidanceSafe}}</text>
                      <text class="day-guidance">{{getDailyGuidance(day, currentWeekData.phase)}}</text>
                    </view>
                  </view>
                </block>
              </view>
            </view>

            

            <view class="week-actions">
              <view wx:if="{{userProgress.week_completion[currentWeek]}}" class="completion-info">
                <text class="completion-status">âœ… å·²å®Œæˆ</text>
                <text class="completion-rate">å®Œæˆç‡ï¼š{{userProgress.week_completion[currentWeek].completion_rate}}%</text>
              </view>
              <button 
                wx:else 
                class="upload-btn {{currentWeek === userProgress.current_week ? 'primary-btn' : 'secondary-btn'}}"
                bindtap="uploadWeekSummary"
                data-week="{{currentWeek}}">
                {{currentWeek === userProgress.current_week ? 'å‘¨æ‰“å¡' : 'è¡¥äº¤å‘¨æ‰“å¡'}}
              </button>
            </view>
          </view>
          <view wx:if="{{expandedWeeks[currentWeek] && isLocked}}" class="locked-card">
            <text class="locked-title">å·²é”å®š</text>
            <text class="locked-desc">å®Œæˆä¸Šä¸€å‘¨æ‰“å¡å¹¶é€šè¿‡å®¡æ ¸åè§£é”ä¸‹ä¸€å‘¨è®­ç»ƒè®¡åˆ’ã€‚</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <view class="intensity-card" style="position: relative; left: 0rpx; top: -54rpx">
    <text class="intensity-title">å¼ºåº¦åˆ†åŒºç®€è¿°</text>
    <text class="intensity-text">Z1 æ¢å¤ Â· Z2 æœ‰æ°§åŸºç¡€ Â· Z3 èŠ‚å¥å¼ºåŒ– Â· Z4 é˜ˆå€¼è®­ç»ƒ Â· Z5 çŸ­å†²åˆºã€‚æŒ‰ä¸ªäººé˜ˆå€¼è®¡ç®—æ›´ç²¾å‡†ã€‚</text>
    <button class="intensity-btn" bindtap="navigateToTrainingAssistant">è®¡ç®—ä¸ªäººåˆ†åŒº</button>
  </view>

  
  <!-- æ•™ç»ƒæç¤ºï¼ˆåº•éƒ¨ï¼Œæ— è·³è½¬ï¼‰ -->
  <view class="coach-note-section">
    <view class="coach-note-card" style="position: relative; left: 0rpx; top: -52rpx; height: 183rpx; display: block; box-sizing: border-box">
      <view class="coach-header" style="position: relative; left: -2rpx; top: -31rpx">
        <text class="coach-icon">ğŸ‘¨â€ğŸ«</text>
        <text class="coach-title">æ•™ç»ƒæç¤º</text>
      </view>
      <text class="coach-content" style="position: relative; left: 2rpx; top: -50rpx">{{campData.coach_note}}</text>
    </view>
  </view>
</view>
