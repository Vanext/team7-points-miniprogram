<!--图片测试页面-->
<view class="container">
  <view class="header">
    <text class="title">图片跨设备显示测试</text>
    <text class="subtitle">诊断云存储图片显示问题</text>
  </view>

  <!-- 操作按钮 -->
  <view class="actions">
    <button class="action-btn primary" bindtap="chooseAndUploadImage" loading="{{loading}}">
      {{loading ? '上传中...' : '选择并上传图片'}}
    </button>
    <button class="action-btn" bindtap="testExistingImage">测试现有图片</button>
    <button class="action-btn" bindtap="callOcrMvpLatest">OCR识别最新上传</button>
    <button class="action-btn danger" bindtap="clearResults">清除结果</button>
  </view>

  <!-- 云存储环境信息 -->
  <view class="env-info">
    <text class="section-title">云存储环境</text>
    <view class="info-item">
      <text class="label">环境ID:</text>
      <text class="value">{{cloudEnvId}}</text>
    </view>
    <view class="info-item">
      <text class="label">图片文件夹:</text>
      <text class="value">{{imageFolder}}</text>
    </view>
  </view>

  <view class="partners-section">
    <text class="section-title">合作伙伴Logo上传</text>
    <view class="partners-grid">
      <view class="partner-item">
        <text class="partner-name">Descente</text>
        <button class="mini-btn" data-key="descente" bindtap="choosePartner">选择并上传</button>
        <image class="partner-preview" src="{{partnerMap.descente.tempURL}}" mode="aspectFit"/>
        <text class="fid">{{partnerMap.descente.fileID}}</text>
      </view>
      <view class="partner-item">
        <text class="partner-name">QRTRI</text>
        <button class="mini-btn" data-key="qrtri" bindtap="choosePartner">选择并上传</button>
        <image class="partner-preview" src="{{partnerMap.qrtri.tempURL}}" mode="aspectFit"/>
        <text class="fid">{{partnerMap.qrtri.fileID}}</text>
      </view>
      <view class="partner-item">
        <text class="partner-name">QUINTANA ROO</text>
        <button class="mini-btn" data-key="quintanaroo" bindtap="choosePartner">选择并上传</button>
        <image class="partner-preview" src="{{partnerMap.quintanaroo.tempURL}}" mode="aspectFit"/>
        <text class="fid">{{partnerMap.quintanaroo.fileID}}</text>
      </view>
      <view class="partner-item">
        <text class="partner-name">凯睿海恩</text>
        <button class="mini-btn" data-key="kse" bindtap="choosePartner">选择并上传</button>
        <image class="partner-preview" src="{{partnerMap.kse.tempURL}}" mode="aspectFit"/>
        <text class="fid">{{partnerMap.kse.fileID}}</text>
      </view>
    </view>
  </view>

  <!-- 测试结果 -->
  <view class="test-results" wx:if="{{uploadedImages.length > 0}}">
    <text class="section-title">测试结果</text>
    <view class="result-item" wx:for="{{uploadedImages}}" wx:key="id">
      <view class="result-header">
        <text class="result-title">测试 #{{index + 1}}</text>
        <text class="result-time">{{item.timestamp}}</text>
      </view>
      
      <view class="result-content">
        <!-- 原始信息 -->
        <view class="info-group">
          <text class="group-title">原始信息</text>
          <view class="info-item">
            <text class="label">FileID:</text>
            <text class="value small" bindtap="copyUrl" data-url="{{item.fileID}}">{{item.fileID}}</text>
          </view>
        </view>

        <!-- URL转换结果 -->
        <view class="info-group">
          <text class="group-title">URL转换</text>
          <view class="info-item">
            <text class="label">状态:</text>
            <text class="value status-{{item.status}}">{{item.status}}</text>
          </view>
          <view class="info-item" wx:if="{{item.tempURL}}">
            <text class="label">临时URL:</text>
            <text class="value small" bindtap="copyUrl" data-url="{{item.tempURL}}">{{item.tempURL}}</text>
          </view>
          <view class="info-item" wx:if="{{item.error}}">
            <text class="label">错误:</text>
            <text class="value error">{{item.error}}</text>
          </view>
        </view>

        <!-- 图片显示测试 -->
        <view class="info-group" wx:if="{{item.tempURL}}">
          <text class="group-title">图片显示测试</text>
          <view class="image-test">
            <image 
              class="test-image" 
              src="{{item.tempURL}}" 
              mode="aspectFit"
              data-id="{{item.id}}"
              binderror="onImageError"
              bindload="onImageLoad"
            />
            <view class="image-status">
              <text class="label">显示状态:</text>
              <text class="value status-{{item.displayStatus || 'pending'}}">
                {{item.displayStatus || '等待中'}}
              </text>
            </view>
            <view class="image-error" wx:if="{{item.displayError}}">
              <text class="error">{{item.displayError}}</text>
            </view>
          </view>
        </view>

        <!-- 操作按钮 -->
        <view class="result-actions">
          <button class="mini-btn" bindtap="retestUrlConversion" data-id="{{item.id}}">
            重新测试
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- OCR 识别结果 -->
  <view class="ocr-section" wx:if="{{ocrText}}">
    <text class="section-title">OCR 识别结果（MVP）</text>
    <text class="ocr-text">{{ocrText}}</text>
  </view>

  <!-- 调试日志 -->
  <view class="debug-section">
    <text class="section-title">调试日志</text>
    <scroll-view class="debug-log" scroll-y="true">
      <view class="log-item log-{{item.type}}" wx:for="{{debugInfo}}" wx:key="timestamp">
        <text class="log-time">{{item.timestamp}}</text>
        <text class="log-message">{{item.message}}</text>
      </view>
    </scroll-view>
  </view>
  <canvas canvas-id="partnerCanvas" style="width: {{canvasWidth}}px; height: {{canvasHeight}}px; position: absolute; left: -9999px; top: -9999px;"></canvas>
</view>
