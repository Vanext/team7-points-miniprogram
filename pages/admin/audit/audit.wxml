<!--pages/admin/audit/audit.wxml-->
<view class="container">
  <!-- 权限检查 -->
  <block wx:if="{{!isAdmin}}">
    <view class="no-access">
      <text>正在检查权限...</text>
    </view>
  </block>
  
  <block wx:else>
    <!-- 标签页 -->
    <view class="tabs-container">
      <view class="tabs">
        <view 
          wx:for="{{tabs}}" 
          wx:key="id" 
          class="tab {{currentTab === item.id ? 'active' : ''}}" 
          bindtap="onTabChange"
          data-id="{{item.id}}"
        >
          <text class="tab-text">{{item.name}}</text>
          <view class="tab-indicator" wx:if="{{currentTab === item.id}}"></view>
        </view>
      </view>
    </view>
    
    <!-- 记录列表 -->
    <scroll-view scroll-y class="records-scroll" bindscrolltolower="onReachBottom" enable-back-to-top>
      <view class="records-list">
        <block wx:if="{{records.length > 0}}">
          <view 
            wx:for="{{records}}" 
            wx:key="_id" 
            class="record-card {{item.autoApproved ? 'auto-approved' : ''}}"
            data-id="{{item._id}}"
            bindtap="{{currentTab === 'rejected' ? 'viewDetail' : ''}}"
          >
            <!-- 主要内容区域：左侧信息 + 右侧图片 -->
            <view class="card-main">
              <!-- 左侧信息区 -->
              <view class="card-info">
                <!-- 顶部：头像、名字、日期 -->
                <view class="info-header">
                  <image class="avatar" src="{{item.userInfo.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
                  <view class="user-meta">
                    <view class="name-row">
                      <text class="name">{{item.userInfo.nickName || '用户'}}</text>
                      <text class="category-tag">{{item.category}}</text>
                    </view>
                    <text class="date">{{item.submitTimeFormatted}}</text>
                  </view>
                  <view class="points-badge">+{{item.points}}</view>
                </view>

                <!-- 中部：描述文本 -->
                <view class="info-desc">
                  <text class="desc-text">{{item.description || '无描述'}}</text>
                  <view class="reject-reason" wx:if="{{currentTab === 'rejected' && item.rejectReason}}">
                    <text class="reason-label">驳回:</text> {{item.rejectReason}}
                  </view>
                </view>
              </view>

              <!-- 右侧图片区 (如果有图) -->
              <view class="card-media" wx:if="{{item.thumb}}" catchtap="previewImages" data-images="{{item.images}}">
                <image src="{{item.thumb}}" mode="aspectFill" class="media-img"></image>
                <view class="img-count" wx:if="{{item.images.length > 1}}">{{item.images.length}}</view>
              </view>
            </view>
            
            <!-- 底部操作栏 -->
            <view class="card-actions">
              <view class="status-tag" wx:if="{{item.autoApproved}}">
                <text class="icon-auto">⚡</text> 自动通过
              </view>
              <view class="status-tag" wx:elif="{{currentTab === 'approved'}}">
                <text class="icon-check">✓</text> 已通过
              </view>
              <view class="status-tag reject" wx:elif="{{currentTab === 'rejected'}}">
                <text class="icon-close">✕</text> 已拒绝
              </view>
              <view class="spacer"></view>
              
              <view class="btn-group">
                <block wx:if="{{currentTab === 'pending'}}">
                  <view class="action-btn reject" catchtap="rejectRecord" data-id="{{item._id}}">拒绝</view>
                  <view class="action-btn approve" catchtap="approveRecord" data-id="{{item._id}}">通过</view>
                </block>
                <block wx:if="{{currentTab === 'approved'}}">
                  <view class="action-btn warn" catchtap="cancelApproval" data-id="{{item._id}}">撤销</view>
                </block>
                <block wx:if="{{currentTab === 'rejected'}}">
                  <view class="action-btn approve" catchtap="approveRejected" data-id="{{item._id}}">恢复通过</view>
                </block>
              </view>
            </view>
          </view>
        </block>
        
        <view class="empty-state" wx:elif="{{!loading}}">
          <image src="/images/empty.png" mode="widthFix" class="empty-img" wx:if="{{false}}"></image>
          <text>暂无记录</text>
        </view>
        
        <view class="loading-state" wx:if="{{loading}}">
          <text>加载中...</text>
        </view>
        
        <view class="no-more" wx:if="{{!loading && !hasMore && records.length > 0}}">
          <text>没有更多记录了</text>
        </view>
      </view>
    </scroll-view>
  </block>
</view>