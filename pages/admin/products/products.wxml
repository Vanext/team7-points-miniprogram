<view class="container">
  <!-- Sticky Header -->
  <view class="page-header">
    <view class="header-title">商品管理</view>
    <view class="header-actions">
      <button class="action-btn primary" bindtap="onToggleCreateForm">
        <text class="icon">+</text> 新增商品
      </button>
      <button class="action-btn secondary" bindtap="onRefresh" loading="{{loading}}">
        <text class="icon">↻</text>
      </button>
    </view>
  </view>

  <!-- Product List -->
  <scroll-view scroll-y class="content-scroll">
    <view class="grid-list">
      <block wx:for="{{products}}" wx:key="_id">
        <view class="product-card">
          <image class="card-thumb" src="{{(item.images && item.images.length ? item.images[0] : item.image) || '/images/default-product.svg'}}" mode="aspectFill"/>
          
          <view class="card-main">
            <view class="card-header">
              <text class="product-name">{{item.name}}</text>
              <view class="status-badge {{item.isActive ? 'active' : 'inactive'}}">
                {{item.isActive ? '上架中' : '已下架'}}
              </view>
            </view>
            
            <view class="card-meta">
              <view class="meta-item points">
                <text class="label">积分</text>
                <text class="value">{{item.points}}</text>
              </view>
              <view class="meta-divider"></view>
              <view class="meta-item stock">
                <text class="label">库存</text>
                <text class="value">{{item.stock}}</text>
              </view>
            </view>
          </view>

          <view class="card-actions">
            <view class="icon-btn edit" bindtap="onOpenEdit" data-item="{{item}}">✎</view>
            <view class="icon-btn state" bindtap="onToggleActive" data-id="{{item._id}}" data-active="{{item.isActive}}">
              {{item.isActive ? '⬇' : '⬆'}}
            </view>
            <view class="icon-btn delete" bindtap="onDelete" data-id="{{item._id}}">🗑</view>
          </view>
        </view>
      </block>
      
      <view wx:if="{{products.length === 0}}" class="empty-tip">暂无商品</view>
    </view>
  </scroll-view>

  <!-- Create Modal -->
  <view wx:if="{{showCreateForm}}" class="modal-mask" catchtouchmove="true">
    <view class="modal">
      <view class="modal-header">
        <text class="modal-title">新增商品</text>
        <view class="modal-close" bindtap="onToggleCreateForm">×</view>
      </view>
      <scroll-view scroll-y class="modal-body">
        <view class="form-group">
          <view class="form-item">
            <text class="label">商品名称</text>
            <input class="input" placeholder="请输入名称" value="{{form.name}}" bindinput="onInputName"/>
          </view>
          <view class="form-row-2">
            <view class="form-item">
              <text class="label">所需积分</text>
              <input class="input" type="number" placeholder="0" value="{{form.points}}" bindinput="onInputPoints"/>
            </view>
            <view class="form-item">
              <text class="label">总库存</text>
              <input class="input" type="number" placeholder="0" value="{{form.stock}}" bindinput="onInputStock" disabled="{{form.sizesEnabled}}"/>
            </view>
          </view>
          
          <view class="form-item">
            <view class="section-header">
              <text class="label">启用尺码</text>
              <switch checked="{{form.sizesEnabled}}" bindchange="onToggleSizes" color="#1677ff" style="transform: scale(0.7)"/>
            </view>
            <view class="size-grid" wx:if="{{form.sizesEnabled}}">
              <view class="size-item" wx:for="{{['XS','S','M','L','XL','2XL','3XL']}}" wx:key="*this">
                <text class="size-tag">{{item}}</text>
                <input class="size-input" type="number" placeholder="0" value="{{form.sizeStocks && form.sizeStocks[item] || ''}}" data-size="{{item}}" bindinput="onSizeStockInput"/>
              </view>
            </view>
          </view>

          <view class="form-item">
            <text class="label">商品图片</text>
            <view class="images-grid">
              <block wx:for="{{form.images}}" wx:key="*this">
                <view class="image-preview-box">
                  <image src="{{item}}" mode="aspectFill" class="preview-img"/>
                  <view class="remove-btn" bindtap="removeFormImageAt" data-index="{{index}}">×</view>
                </view>
              </block>
              <view class="image-uploader" bindtap="chooseFormImages" wx:if="{{form.images.length < 7}}">
                <text class="plus">+</text>
                <text class="text">上传图片</text>
              </view>
            </view>
          </view>
          
          <view class="form-item">
             <text class="label">描述</text>
             <textarea class="textarea" placeholder="商品描述（可选）" value="{{form.description}}" bindinput="onInputDescription"/>
          </view>
        </view>
      </scroll-view>
      <view class="modal-footer">
        <button class="btn secondary" bindtap="onToggleCreateForm">取消</button>
        <button class="btn primary" bindtap="onCreate" loading="{{creating}}">确认创建</button>
      </view>
    </view>
  </view>

  <!-- Edit Modal (Reused structure logic, kept similar to Create) -->
  <view wx:if="{{showEdit}}" class="modal-mask" catchtouchmove="true">
    <view class="modal">
      <view class="modal-header">
        <text class="modal-title">编辑商品</text>
        <view class="modal-close" bindtap="onCloseEdit">×</view>
      </view>
      <scroll-view scroll-y class="modal-body">
         <view class="form-group">
          <view class="form-item">
            <text class="label">商品名称</text>
            <input class="input" placeholder="请输入名称" value="{{editForm.name}}" bindinput="onEditName"/>
          </view>
          <view class="form-row-2">
            <view class="form-item">
              <text class="label">所需积分</text>
              <input class="input" type="number" value="{{editForm.points}}" bindinput="onEditPoints"/>
            </view>
            <view class="form-item">
              <text class="label">总库存</text>
              <input class="input" type="number" value="{{editForm.stock}}" bindinput="onEditStock" disabled="{{editForm.sizesEnabled}}"/>
            </view>
          </view>
          
          <view class="form-item">
            <view class="section-header">
              <text class="label">启用尺码</text>
              <switch checked="{{editForm.sizesEnabled}}" bindchange="onEditToggleSizes" color="#1677ff" style="transform: scale(0.7)"/>
            </view>
            <view class="size-grid" wx:if="{{editForm.sizesEnabled}}">
              <view class="size-item" wx:for="{{['XS','S','M','L','XL','2XL','3XL']}}" wx:key="*this">
                <text class="size-tag">{{item}}</text>
                <input class="size-input" type="number" placeholder="0" value="{{editForm.sizeStocks && editForm.sizeStocks[item] || ''}}" data-size="{{item}}" bindinput="onEditSizeStockInput"/>
              </view>
            </view>
          </view>

          <view class="form-item">
            <text class="label">商品图片</text>
            <view class="images-grid">
              <block wx:for="{{editForm.images}}" wx:key="*this">
                <view class="image-preview-box">
                  <image src="{{item}}" mode="aspectFill" class="preview-img"/>
                  <view class="remove-btn" bindtap="removeEditImageAt" data-index="{{index}}">×</view>
                </view>
              </block>
              <view class="image-uploader" bindtap="chooseEditImages" wx:if="{{editForm.images.length < 7}}">
                <text class="plus">+</text>
                <text class="text">上传图片</text>
              </view>
            </view>
          </view>

           <view class="form-item">
             <text class="label">描述</text>
             <textarea class="textarea" placeholder="商品描述（可选）" value="{{editForm.description}}" bindinput="onEditDescription"/>
          </view>
        </view>
      </scroll-view>
      <view class="modal-footer">
        <button class="btn secondary" bindtap="onCloseEdit">取消</button>
        <button class="btn primary" bindtap="onSubmitEdit" loading="{{updating}}">保存修改</button>
      </view>
    </view>
  </view>
</view>
