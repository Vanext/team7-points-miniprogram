<!--pages/admin/members/members.wxml-->
<view class="container">
  <block wx:if="{{!isAdmin}}">
    <view class="no-access-card">
      <view class="no-access-icon">ğŸ”’</view>
      <view class="no-access-title">æƒé™ä¸è¶³</view>
      <view class="no-access-desc">åªæœ‰ç®¡ç†å‘˜æ‰èƒ½è®¿é—®æ­¤é¡µé¢</view>
    </view>
  </block>
  <block wx:else>
    <!-- é¡µé¢æ ‡é¢˜ -->
    <view class="page-header" style="position: relative; left: 0rpx; top: 0rpx; height: 164rpx; display: block; box-sizing: border-box">
      <text class="page-title">æˆå‘˜ç®¡ç†</text>
      <text class="members-summary-inline" style="position: relative; left: 0rpx; top: -12rpx">æ€»äººæ•° {{totalCount}}ï½œæ­£å¼ä¼šå‘˜ {{officialCount}}</text>
      
    </view>

    <!-- æœç´¢åŒºåŸŸ -->
    <view class="search-card" style="position: relative; left: 0rpx; top: -39rpx; height: 120rpx; display: block; box-sizing: border-box">
      <view class="search-container">
        <view class="search-input-wrapper">
          <text class="search-icon">ğŸ”</text>
          <input class="search-input" placeholder="æœç´¢æˆå‘˜æ˜µç§°æˆ–OpenID" bindinput="onKeyword" value="{{keyword}}"/>
        </view>
        <button class="btn btn-primary search-btn" bindtap="onSearch">æœç´¢</button>
      </view>
    </view>

    <!-- æˆå‘˜åˆ—è¡¨ -->
    <view class="members-container" style="position: relative; left: 0rpx; top: -58rpx">
      <view class="list-header">
        <view class="header-info">
          <text class="section-title">æˆå‘˜åˆ—è¡¨</text>
          <view class="member-count-badge">{{list.length}}</view>
        </view>
        <view class="sort-actions">
          <button class="sort-btn {{sortBy==='points'?'active':''}}" bindtap="onSortByPoints">æŒ‰ç§¯åˆ†</button>
          <button class="sort-btn {{sortBy==='name'?'active':''}}" bindtap="onSortByName">æŒ‰å§“å</button>
        </view>
        <button class="export-btn" bindtap="onExportData" disabled="{{loading || list.length === 0}}">
          <text class="icon">ğŸ“Š</text>
          <text>å¯¼å‡º</text>
        </button>
      </view>
      
      <view class="members-grid">
        <block wx:for="{{list}}" wx:key="_id">
          <view class="member-card">
            <view class="card-header">
              <view class="user-block" style="height: 97rpx; display: flex; box-sizing: border-box">
                <view class="name-line">
                  <text class="user-name">{{item.nickName || 'æœªçŸ¥æ˜µç§°'}}</text>
                  <text class="badge {{item.isActivated ? 'active' : 'inactive'}}">{{item.isActivated ? 'å·²æ¿€æ´»' : 'æœªæ¿€æ´»'}}</text>
                  <text class="badge admin" wx:if="{{item.isAdmin}}">ç®¡ç†å‘˜</text>
                  <text class="badge member" wx:if="{{item.isOfficialMember}}">æ­£å¼ä¼šå‘˜</text>
                  <text class="badge paid {{item.paidThisYear ? 'yes' : 'no'}}" wx:if="{{item.isOfficialMember}}" style="position: relative; left: 391rpx; top: -56rpx">{{item.paidThisYear ? 'å·²ç¼´è´¹' : 'æœªç¼´è´¹'}}</text>
                </view>
                
              </view>
              <view class="metrics">
                <view class="points-row">
                  <text class="points-label">ç§¯åˆ†</text>
                  <text class="points-value {{item.totalPoints < 0 ? 'negative-points' : ''}}">{{item.totalPoints || 0}}</text>
                </view>
                <text class="lock-badge {{item.exchange_locked ? 'locked' : 'unlocked'}}" wx:if="{{item.exchange_locked !== undefined}}">{{item.exchange_locked ? 'ğŸ”’ å·²é”å®š' : 'ğŸ”“ å·²è§£é”'}}</text>
              </view>
            </view>

            <view class="card-actions actions-grid">
              <button 
                class="action-btn admin-btn {{item.isAdmin ? 'remove' : 'add'}}"
                data-user-id="{{item._id}}"
                data-is-admin="{{item.isAdmin}}"
                data-nick-name="{{item.nickName}}"
                bindtap="toggleAdminStatus">
                <text class="btn-icon">{{item.isAdmin ? 'ğŸ‘¤' : 'â­'}}</text>
                <text class="btn-text">{{item.isAdmin ? 'å–æ¶ˆç®¡ç†å‘˜' : 'è®¾ç½®ç®¡ç†å‘˜'}}</text>
              </button>
              
              <button 
                class="action-btn lock-btn {{item.exchange_locked ? 'unlock' : 'lock'}}"
                data-user-id="{{item._id}}"
                data-is-locked="{{item.exchange_locked}}"
                data-nick-name="{{item.nickName}}"
                bindtap="toggleExchangeLock">
                <text class="btn-icon">{{item.exchange_locked ? 'ğŸ”“' : 'ğŸ”’'}}</text>
                <text class="btn-text">{{item.exchange_locked ? 'è§£é”å…‘æ¢' : 'é”å®šå…‘æ¢'}}</text>
              </button>
              <!-- å°†æ–°ç§¯åˆ†è¾“å…¥æ¡†ä½œä¸ºç¬¬ä¸€è¡Œç¬¬ä¸‰åˆ— -->
              <input 
                class="points-input grid-input" 
                type="text" 
                placeholder="æ–°ç§¯åˆ†" 
                data-id="{{item._id}}" 
                bindinput="onNewPointsInput"
                value="{{newPointsMap[item._id] || ''}}"
              />

              <!-- ç¬¬äºŒè¡Œç¬¬ä¸€åˆ—ï¼šæ­£å¼ä¼šå‘˜å¼€å…³ -->
              <button
                class="action-btn admin-btn"
                data-user-id="{{item._id}}"
                data-is-official="{{item.isOfficialMember}}"
                data-nick-name="{{item.nickName}}"
                bindtap="toggleOfficialMember">
                <text class="btn-icon">{{item.isOfficialMember ? 'ğŸ…' : 'ğŸ‘¤'}}</text>
                <text class="btn-text">{{item.isOfficialMember ? 'å–æ¶ˆæ­£å¼ä¼šå‘˜' : 'è®¾ä¸ºæ­£å¼ä¼šå‘˜'}}</text>
              </button>

              <!-- ç¬¬äºŒè¡Œç¬¬äºŒåˆ—ï¼šå½“å¹´ç¼´è´¹æ ‡è®°æŒ‰é’®ï¼ˆéšçŠ¶æ€å˜è‰²ï¼‰ -->
              <button
                class="action-btn admin-btn paid-btn {{item.paidThisYear ? 'is-paid' : 'not-paid'}}"
                data-user-id="{{item._id}}"
                data-nick-name="{{item.nickName}}"
                bindtap="markPaidThisYear">
                <text class="btn-icon">ğŸ’³</text>
                <text class="btn-text">æ ‡è®°ç¼´è´¹</text>
              </button>

              <!-- ç¬¬äºŒè¡Œç¬¬ä¸‰åˆ—ï¼šè®¾ç½®ç§¯åˆ†æŒ‰é’® -->
              <button 
                class="set-points-btn grid-set-btn" 
                data-id="{{item._id}}" 
                data-openid="{{item._openid}}" 
                bindtap="onSetPoints"
                disabled="{{newPointsMap[item._id] === '' || newPointsMap[item._id] === null}}">
                <text class="btn-icon">ğŸ’</text>
                <text class="btn-text">è®¾ç½®</text>
              </button>
            </view>
          </view>
        </block>
        
        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-state" wx:if="{{list.length === 0}}">
          <view class="empty-icon">ğŸ‘¥</view>
          <text class="empty-title">æš‚æ— æˆå‘˜æ•°æ®</text>
          <text class="empty-desc">{{keyword ? 'æœªæ‰¾åˆ°åŒ¹é…çš„æˆå‘˜' : 'è¿˜æ²¡æœ‰æˆå‘˜åŠ å…¥'}}</text>
        </view>
      </view>

      <!-- åŠ è½½æ›´å¤š -->
      <view class="load-more-section" wx:if="{{list.length > 0}}">
        <button 
          class="load-more-btn" 
          bindtap="onLoadMore" 
          disabled="{{loading || noMore}}"
        >
          <text class="load-icon">{{loading ? 'â³' : (noMore ? 'âœ…' : 'â¬‡ï¸')}}</text>
          <text>{{noMore ? 'å·²åŠ è½½å…¨éƒ¨' : (loading ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š')}}</text>
        </button>
      </view>
    </view>
  </block>
</view>