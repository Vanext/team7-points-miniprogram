<!--pages/admin/members/members.wxml-->
<view class="container">
  <block wx:if="{{!isAdmin}}">
    <view class="no-access-card">
      <view class="no-access-icon">ğŸ”’</view>
      <view class="no-access-title">æƒé™ä¸è¶³</view>
      <view class="no-access-desc">åªæœ‰ç®¡ç†å‘˜æ‰èƒ½è®¿é—®æ­¤é¡µé¢</view>
    </view>
  </block>
  <block wx:else>
    <!-- é¡¶éƒ¨ç»Ÿè®¡ä¸æœç´¢åŒº (å¸é¡¶) -->
    <view class="header-section">
      <view class="stats-row">
        <text class="page-title">æˆå‘˜ç®¡ç†</text>
        <text class="stats-info">æ€»äººæ•° {{totalCount}}ï½œæ­£å¼ä¼šå‘˜ {{officialCount}}</text>
      </view>

      <view class="search-bar">
        <view class="search-input-wrap">
          <text class="search-icon">ğŸ”</text>
          <input class="search-input" placeholder="æœç´¢æ˜µç§°æˆ–OpenID" bindinput="onKeyword" value="{{keyword}}"/>
        </view>
        <button class="btn-primary search-btn" bindtap="onSearch">æœç´¢</button>
      </view>
      
      <view class="filter-row">
        <view class="sort-group">
          <view class="sort-item {{sortBy==='points'?'active':''}}" bindtap="onSortByPoints">æŒ‰ç§¯åˆ†</view>
          <view class="sort-item {{sortBy==='name'?'active':''}}" bindtap="onSortByName">æŒ‰å§“å</view>
        </view>
        <view class="action-group">
          <view class="export-btn" bindtap="onExportData" disabled="{{loading || list.length === 0}}">
            <text>å¯¼å‡ºæ•°æ®</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æˆå‘˜åˆ—è¡¨ -->
    <scroll-view scroll-y class="members-scroll" enable-back-to-top bindscrolltolower="onLoadMore" lower-threshold="100">
      <view class="members-list">
        <block wx:for="{{list}}" wx:key="_id">
          <view class="member-card" bindtap="onOpenMemberModal" data-id="{{item._id}}">
            <!-- ä¸ŠåŠéƒ¨åˆ†ï¼šä¿¡æ¯å±•ç¤º -->
            <view class="card-main">
              <view class="info-column">
                <view class="name-row">
                  <text class="user-name">{{item.nickName || 'æœªçŸ¥ç”¨æˆ·'}}</text>
                  <!-- é”çŠ¶æ€æŒ‡ç¤ºå™¨ (å›¾æ ‡) -->
                  <text class="lock-indicator" wx:if="{{item.isOfficialMember && item.exchange_locked}}">ğŸ”’</text>
                </view>
                <view class="tags-row">
                  <!-- æ–‡æœ¬æ ‡ç­¾ï¼Œæ¸…æ™°æ˜“æ‡‚ -->
                  <text class="tag admin" wx:if="{{item.isAdmin}}">ç®¡ç†å‘˜</text>
                  <text class="tag official" wx:if="{{item.isOfficialMember}}">æ­£å¼ä¼šå‘˜</text>
                  <text class="tag paid" wx:if="{{item.isOfficialMember && item.officialMemberUntilText}}">åˆ°æœŸ {{item.officialMemberUntilText}}</text>
                  <text class="tag guest" wx:if="{{!item.isOfficialMember}}">æ™®é€šç”¨æˆ·</text>
                  <text class="tag active" wx:if="{{item.isExchangeActivated}}">å·²æ¿€æ´»</text>
                  <text class="tag inactive" wx:if="{{item.isOfficialMember && !item.isExchangeActivated}}">æœªæ¿€æ´»</text>
                </view>
              </view>
              
              <view class="points-column">
                <text class="points-val {{item.totalPoints < 0 ? 'negative' : ''}}">{{item.totalPoints || 0}}</text>
                <text class="points-unit">åˆ†</text>
              </view>
            </view>

            <!-- ä¸‹åŠéƒ¨åˆ†ï¼šæ“ä½œåŒºåŸŸ -->
            <view class="card-actions" catchtap="noop">
              <!-- ç§¯åˆ†è®¾ç½® -->
              <view class="action-group-left">
                <input 
                  class="points-input" 
                  type="number" 
                  placeholder="Â±ç§¯åˆ†" 
                  data-id="{{item._id}}" 
                  bindinput="onNewPointsInput"
                  value="{{newPointsMap[item._id] || ''}}"
                />
                <view class="btn-small primary" data-id="{{item._id}}" bindtap="onSetPoints">ä¿®æ”¹</view>
              </view>
              
              <!-- çŠ¶æ€åˆ‡æ¢æŒ‰é’® (å¸¦æ–‡å­—) -->
              <view class="action-group-right">
                <view class="btn-text {{item.isAdmin ? 'active' : ''}}" catchtap="toggleAdminStatus" data-user-id="{{item._id}}" data-is-admin="{{item.isAdmin}}" data-nick-name="{{item.nickName}}">
                  ç®¡ç†å‘˜
                </view>
                <view class="btn-text {{item.isOfficialMember ? 'active' : ''}}" catchtap="toggleOfficialMember" data-user-id="{{item._id}}" data-is-official="{{item.isOfficialMember}}" data-nick-name="{{item.nickName}}">
                  æ­£å¼ä¼šå‘˜
                </view>
                <view class="btn-text {{item.exchange_locked ? 'danger' : ''}}" catchtap="toggleExchangeLock" data-user-id="{{item._id}}" data-is-locked="{{item.exchange_locked}}" data-nick-name="{{item.nickName}}" wx:if="{{item.isOfficialMember}}">
                  {{item.exchange_locked ? 'è§£é”' : 'é”å®š'}}
                </view>
              </view>
            </view>
          </view>
        </block>

        <view class="member-modal-mask" wx:if="{{memberModalVisible}}" catchtap="onCloseMemberModal">
          <view class="member-modal" catchtap="noop">
            <view class="member-modal-header">
              <text class="member-modal-title">æˆå‘˜è®¾ç½®</text>
              <view class="member-modal-close" catchtap="onCloseMemberModal">âœ•</view>
            </view>

            <view class="member-modal-body">
              <view class="member-modal-row">
                <text class="member-modal-label">æ˜µç§°</text>
                <text class="member-modal-value">{{memberModalUser.nickName || 'æœªçŸ¥ç”¨æˆ·'}}</text>
              </view>
              <view class="member-modal-row">
                <text class="member-modal-label">ç§¯åˆ†</text>
                <text class="member-modal-value">{{memberModalUser.totalPoints || 0}}</text>
              </view>
              <view class="member-modal-row">
                <text class="member-modal-label">æ­£å¼ä¼šå‘˜</text>
                <text class="member-modal-value">{{memberModalUser.isOfficialMember ? 'æ˜¯' : 'å¦'}}</text>
              </view>
              <view class="member-modal-row">
                <text class="member-modal-label">å…‘æ¢çŠ¶æ€</text>
                <text class="member-modal-value">{{memberModalUser.isExchangeActivated ? 'å·²æ¿€æ´»' : (memberModalUser.isOfficialMember ? 'æœªæ¿€æ´»' : '-') }}</text>
              </view>

              <view class="member-modal-section">
                <view class="member-modal-section-title">åˆ°æœŸæ—¥æœŸ</view>
                <picker mode="date" value="{{memberModalExpiryDate}}" bindchange="onMemberExpiryChange">
                  <view class="member-modal-picker">
                    <text class="member-modal-picker-text">{{memberModalExpiryDate || 'è¯·é€‰æ‹©æ—¥æœŸ'}}</text>
                    <text class="member-modal-picker-arrow">â€º</text>
                  </view>
                </picker>
                <view class="member-modal-hint" wx:if="{{!memberModalUser.isOfficialMember}}">ä¿å­˜å°†è‡ªåŠ¨è®¾ä¸ºæ­£å¼ä¼šå‘˜</view>
              </view>
            </view>

            <view class="member-modal-footer">
              <view class="member-modal-btn" catchtap="onCloseMemberModal">å–æ¶ˆ</view>
              <view class="member-modal-btn primary" catchtap="onSaveMemberExpiry" wx:if="{{memberModalExpiryDate}}">ä¿å­˜</view>
            </view>
          </view>
        </view>
        
        <view class="loading-state" wx:if="{{loading}}">
          <text>åŠ è½½ä¸­...</text>
        </view>
        
        <view class="empty-state" wx:if="{{list.length === 0 && !loading}}">
          <text>æœªæ‰¾åˆ°åŒ¹é…æˆå‘˜</text>
        </view>

        <view class="no-more-state" wx:if="{{noMore && list.length > 0}}">
          <text>-- æ²¡æœ‰æ›´å¤šæ•°æ®äº† --</text>
        </view>
      </view>
    </scroll-view>
  </block>
</view>
