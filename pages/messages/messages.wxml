<!--æ¶ˆæ¯ä¸­å¿ƒé¡µé¢-->
<view class="container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <text class="page-title">æ¶ˆæ¯ä¸­å¿ƒ</text>
    <view class="header-actions">
      <text class="mark-all-read" bindtap="markAllAsRead" wx:if="{{unreadCount[activeTab] > 0}}">
        å…¨éƒ¨å·²è¯»
      </text>
    </view>
  </view>

  <!-- æ ‡ç­¾é¡µ -->
  <view class="tab-bar">
    <view class="tab-item {{activeTab === 'all' ? 'active' : ''}}" 
          data-tab="all" bindtap="onTabChange">
      <text class="tab-text">å…¨éƒ¨</text>
      <view class="badge" wx:if="{{unreadCount.all > 0}}">{{unreadCount.all}}</view>
    </view>
    <view class="tab-item {{activeTab === 'audit_result' ? 'active' : ''}}" 
          data-tab="audit_result" bindtap="onTabChange">
      <text class="tab-text">ç§¯åˆ†å®¡æ ¸</text>
      <view class="badge" wx:if="{{unreadCount.audit_result > 0}}">{{unreadCount.audit_result}}</view>
    </view>
    <view class="tab-item {{activeTab === 'exchange_status' ? 'active' : ''}}" 
          data-tab="exchange_status" bindtap="onTabChange">
      <text class="tab-text">å…‘æ¢çŠ¶æ€</text>
      <view class="badge" wx:if="{{unreadCount.exchange_status > 0}}">{{unreadCount.exchange_status}}</view>
    </view>
    <view class="tab-item {{activeTab === 'system' ? 'active' : ''}}" 
          data-tab="system" bindtap="onTabChange">
      <text class="tab-text">ç³»ç»Ÿæ¶ˆæ¯</text>
      <view class="badge" wx:if="{{unreadCount.system > 0}}">{{unreadCount.system}}</view>
    </view>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <view class="message-list">
    <view class="message-item {{!item.isRead ? 'unread' : ''}}" 
          wx:for="{{messages}}" wx:key="_id"
          data-message="{{item}}" bindtap="onMessageTap">
      
      <!-- æ¶ˆæ¯å›¾æ ‡ -->
      <view class="message-icon">
        <view class="icon-wrapper {{item.type}}">
          <text class="icon" wx:if="{{item.type === 'audit_result'}}">âœ“</text>
          <text class="icon" wx:elif="{{item.type === 'exchange_status'}}">ğŸ“¦</text>
          <text class="icon" wx:else="{{item.type === 'system'}}">â„¹</text>
        </view>
        <view class="unread-dot" wx:if="{{!item.isRead}}"></view>
      </view>

      <!-- æ¶ˆæ¯å†…å®¹ -->
      <view class="message-content">
        <view class="message-title">{{item.title}}</view>
        <view class="message-text">{{item.content}}</view>
        <view class="message-time">{{formatTime(item.createdAt)}}</view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="message-actions" catchtap="deleteMessage" data-id="{{item._id}}">
        <text class="delete-btn">åˆ é™¤</text>
      </view>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-wrapper" wx:if="{{loading}}">
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && messages.length === 0}}">
      <view class="empty-icon">ğŸ“­</view>
      <text class="empty-text">æš‚æ— æ¶ˆæ¯</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤š -->
    <view class="no-more" wx:if="{{!loading && !hasMore && messages.length > 0}}">
      <text class="no-more-text">æ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†</text>
    </view>
  </view>
</view>